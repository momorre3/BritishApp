<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>British English Coach — 専属発音コーチ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,500;0,600;1,500&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f8fafc; }
        .font-serif-title { font-family: 'Cormorant Garamond', serif; }
        .recording-glow { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(30, 58, 95, 0.5); }
            70% { box-shadow: 0 0 0 14px rgba(30, 58, 95, 0); }
            100% { box-shadow: 0 0 0 0 rgba(30, 58, 95, 0); }
        }
        .gauge-bar { transition: width 0.5s ease-out; }
        .coach-card { border-left: 4px solid #1e3a5f; }
    </style>
</head>
<body class="min-h-screen text-slate-800 antialiased">
    <div class="max-w-lg mx-auto bg-white min-h-screen shadow-lg">
        <!-- Header: British Navy -->
        <header class="bg-[#1e3a5f] text-white px-6 py-5">
            <h1 class="font-serif-title text-2xl font-semibold tracking-tight">British English Coach</h1>
            <p class="text-sm text-white/80 mt-1">あなた専属のRP発音コーチ</p>
        </header>

        <main class="p-6 pb-10">
            <!-- Target Phrase -->
            <section class="mb-6">
                <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Target Phrase</p>
                <p id="targetPhrase" class="text-xl font-medium text-slate-800 leading-snug bg-slate-50 border border-slate-200 rounded-xl p-4">
                    Actually, I'd rather have a cup of <span class="bg-amber-100 text-amber-900 px-1 border-b-2 border-amber-400">tea</span>, if you don't mind.
                </p>
                <p class="text-xs text-slate-400 mt-1">Step <span id="phraseStep">1</span> of <span id="phraseTotal">5</span></p>
            </section>

            <!-- Coach Visual Advice (replaces waveform) -->
            <section class="mb-6 bg-slate-50 border border-slate-200 rounded-xl p-4">
                <p class="text-xs font-semibold text-[#1e3a5f] uppercase tracking-wider mb-2">コーチの視覚的アドバイス</p>
                <div id="coachVisual" class="space-y-2 min-h-[4rem]">
                    <p id="drillTitle" class="text-sm font-semibold text-slate-700">—</p>
                    <p id="drillIpa" class="text-lg font-medium text-[#1e3a5f] font-mono">/ — /</p>
                    <p id="drillTip" class="text-sm text-slate-600 leading-relaxed">録音して分析すると、イントネーション（↘︎↗︎）や口の形のアドバイスがここに表示されます。</p>
                </div>
            </section>

            <!-- Record Button -->
            <section class="flex flex-col items-center gap-4 mb-8">
                <button id="recordBtn" type="button" class="w-20 h-20 rounded-full bg-[#1e3a5f] text-white flex items-center justify-center shadow-lg hover:bg-[#2d4a6f] active:scale-95 transition-all focus:outline-none focus:ring-2 focus:ring-[#1e3a5f]/50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                </button>
                <p id="statusText" class="text-sm text-slate-500">押している間だけ録音／離すと分析開始</p>
            </section>

            <!-- Scores: Progress bars -->
            <section class="grid grid-cols-3 gap-3 mb-6">
                <div class="bg-slate-50 rounded-xl p-3 border border-slate-100">
                    <p class="text-[10px] font-bold text-slate-500 uppercase mb-1">Rhythm</p>
                    <div class="h-2 bg-slate-200 rounded-full overflow-hidden mb-1">
                        <div id="rhythmBar" class="gauge-bar h-full bg-[#1e3a5f] rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="rhythmScore" class="text-sm font-bold text-slate-800">—</p>
                </div>
                <div class="bg-slate-50 rounded-xl p-3 border border-slate-100">
                    <p class="text-[10px] font-bold text-slate-500 uppercase mb-1">Vowel</p>
                    <div class="h-2 bg-slate-200 rounded-full overflow-hidden mb-1">
                        <div id="vowelBar" class="gauge-bar h-full bg-[#1e3a5f] rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="vowelScore" class="text-sm font-bold text-slate-800">—</p>
                </div>
                <div class="bg-slate-50 rounded-xl p-3 border border-slate-100">
                    <p class="text-[10px] font-bold text-slate-500 uppercase mb-1">Britishness</p>
                    <div class="h-2 bg-slate-200 rounded-full overflow-hidden mb-1">
                        <div id="britishBar" class="gauge-bar h-full bg-emerald-600 rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="britishScore" class="text-sm font-bold text-slate-800">—</p>
                </div>
            </section>

            <!-- Your Transcript (with highlight support) -->
            <section class="mb-6">
                <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Your Transcript</p>
                <div id="transcriptText" class="text-sm text-slate-700 bg-white border border-slate-200 rounded-xl p-4 min-h-[3.5rem] leading-relaxed">
                    （ここに文字起こしが表示されます。コーチが指摘した箇所はハイライトされます）
                </div>
            </section>

            <!-- Structured Coach Feedback (4 sections) -->
            <section class="mb-6">
                <p class="text-xs font-semibold text-[#1e3a5f] uppercase tracking-wider mb-3">Coach Feedback</p>
                <div id="feedbackText" class="space-y-4">
                    <p class="text-slate-500 text-sm">録音して分析すると、4つのフィードバックがここに表示されます。</p>
                </div>
            </section>

            <!-- Next Step Button -->
            <section class="pt-2 space-y-2">
                <p id="nextStepHint" class="text-xs text-slate-500 hidden"></p>
                <button id="nextStepBtn" type="button" class="w-full py-3 px-4 rounded-xl bg-[#1e3a5f] text-white font-semibold text-sm hover:bg-[#2d4a6f] active:scale-[0.98] transition-all focus:outline-none focus:ring-2 focus:ring-[#1e3a5f]/50 hidden">
                    次の課題に進む
                </button>
            </section>
        </main>
    </div>

    <script>
        const recordBtn = document.getElementById('recordBtn');
        const statusText = document.getElementById('statusText');
        const transcriptText = document.getElementById('transcriptText');
        const feedbackText = document.getElementById('feedbackText');
        const rhythmScoreEl = document.getElementById('rhythmScore');
        const vowelScoreEl = document.getElementById('vowelScore');
        const britishScoreEl = document.getElementById('britishScore');
        const rhythmBar = document.getElementById('rhythmBar');
        const vowelBar = document.getElementById('vowelBar');
        const britishBar = document.getElementById('britishBar');
        const targetPhraseEl = document.getElementById('targetPhrase');
        const drillTitleEl = document.getElementById('drillTitle');
        const drillIpaEl = document.getElementById('drillIpa');
        const drillTipEl = document.getElementById('drillTip');
        const phraseStepEl = document.getElementById('phraseStep');
        const phraseTotalEl = document.getElementById('phraseTotal');
        const nextStepBtn = document.getElementById('nextStepBtn');

        const PHRASES = [
            "Actually, I'd rather have a cup of tea, if you don't mind.",
            "I can't dance in the bath—the floor's too slippery.",
            "The water's better here than in London.",
            "She asked for a fast answer about the project.",
            "We'd rather not talk about the weather."
        ];
        let phraseIndex = 0;
        let lastNextStep = null;

        let mediaRecorder = null;
        let recordedChunks = [];
        let currentStream = null;
        let isRecording = false;
        let stopRequested = false;

        function isTouchDevice() {
            return 'ontouchstart' in window || (navigator.maxTouchPoints || 0) > 0 || (navigator.msMaxTouchPoints || 0) > 0;
        }

        function pickBestMimeType() {
            const candidates = ['audio/webm;codecs=opus', 'audio/webm', 'audio/ogg;codecs=opus', 'audio/ogg'];
            for (const t of candidates) {
                if (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) return t;
            }
            return '';
        }

        function setBusyUI(message) {
            statusText.textContent = message;
            recordBtn.disabled = true;
            recordBtn.classList.add('opacity-60');
        }

        function clearBusyUI(message) {
            statusText.textContent = message;
            recordBtn.disabled = false;
            recordBtn.classList.remove('opacity-60');
        }

        function setRecordingUI(on) {
            if (on) {
                recordBtn.classList.add('recording-glow');
                statusText.classList.remove('animate-pulse');
                statusText.textContent = '録音中…（離すと停止）';
            } else {
                recordBtn.classList.remove('recording-glow');
                statusText.classList.add('animate-pulse');
            }
        }

        function clampScore(n) {
            const x = Number(n);
            if (!Number.isFinite(x)) return null;
            return Math.max(0, Math.min(100, Math.round(x)));
        }

        function updateScores(r, v, b) {
            const set = (el, bar, val) => {
                if (val == null) return;
                el.textContent = val + '%';
                if (bar) bar.style.width = val + '%';
            };
            set(rhythmScoreEl, rhythmBar, r);
            set(vowelScoreEl, vowelBar, v);
            set(britishScoreEl, britishBar, b);
        }

        function renderTranscript(transcript) {
            if (!transcript) {
                transcriptText.innerHTML = '（文字起こし結果なし）';
                return;
            }
            transcriptText.textContent = transcript;
        }

        function renderStructuredFeedback(data) {
            const analysis = data?.analysis || {};
            const detailed = analysis.detailed_feedback || '';
            const nextStep = data?.next_step || {};
            lastNextStep = nextStep.text || nextStep.next_phrase ? nextStep : null;

            feedbackText.innerHTML = detailed
                ? `<div class="coach-card bg-slate-50 rounded-r-lg p-4"><p class="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap">${escapeHtml(detailed)}</p></div>`
                : '<p class="text-slate-500 text-sm">（フィードバックを生成できませんでした）</p>';

            nextStepBtn.textContent = '次の課題に進む';
            const hintEl = document.getElementById('nextStepHint');
            if (hintEl) {
                hintEl.textContent = nextStep.text || '';
                hintEl.classList.toggle('hidden', !nextStep.text);
            }
            nextStepBtn.classList.remove('hidden');
        }

        function escapeHtml(s) {
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        function renderCoachVisual(ipaTarget) {
            drillTitleEl.textContent = '今回のIPAターゲット';
            drillIpaEl.textContent = ipaTarget && ipaTarget.trim() ? ipaTarget.trim() : '/ — /';
            drillTipEl.textContent = '録音して分析すると、イントネーション（↘︎↗︎）や口の形のアドバイスがここに表示されます。';
        }

        function setPhraseIndex(index) {
            phraseIndex = index % PHRASES.length;
            phraseStepEl.textContent = phraseIndex + 1;
            phraseTotalEl.textContent = PHRASES.length;
            targetPhraseEl.innerHTML = highlightPhrase(PHRASES[phraseIndex]);
        }

        function setTargetPhrase(phrase) {
            if (!phrase || !phrase.trim()) return;
            const idx = PHRASES.indexOf(phrase.trim());
            if (idx >= 0) phraseIndex = idx;
            else PHRASES.push(phrase.trim());
            phraseStepEl.textContent = phraseIndex + 1;
            phraseTotalEl.textContent = PHRASES.length;
            targetPhraseEl.innerHTML = highlightPhrase(phrase.trim());
        }

        function highlightPhrase(text) {
            return text.replace(/\b(tea|dance|bath|water|better|fast|rather|can't)\b/gi, '<span class="bg-amber-100 text-amber-900 px-1 border-b-2 border-amber-400">$&</span>');
        }

        function nextPhrase() {
            if (lastNextStep && lastNextStep.next_phrase) {
                setTargetPhrase(lastNextStep.next_phrase);
                lastNextStep = null;
            } else {
                setPhraseIndex(phraseIndex + 1);
            }
            const hintEl = document.getElementById('nextStepHint');
            if (hintEl) hintEl.classList.add('hidden');
            nextStepBtn.classList.add('hidden');
            clearBusyUI(isTouchDevice() ? 'タップで録音開始／もう一度タップで停止' : '押している間だけ録音／離すと分析開始');
        }

        async function startRecording() {
            if (isRecording) return;
            isRecording = true;
            stopRequested = false;
            recordedChunks = [];

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                currentStream = stream;
                const mimeType = pickBestMimeType();
                mediaRecorder = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data && e.data.size > 0) recordedChunks.push(e.data);
                };

                mediaRecorder.onstop = async () => {
                    setRecordingUI(false);
                    setBusyUI('分析中…（数秒かかることがあります）');
                    try {
                        const blob = new Blob(recordedChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                        await sendAudioForCoaching(blob);
                        clearBusyUI(isTouchDevice() ? 'タップで録音／もう一度で停止' : '完了。もう一度押して録音できます。');
                    } catch (err) {
                        console.error(err);
                        const msg = (err && err.message) ? err.message : '分析に失敗しました（サーバー起動/APIキーを確認）';
                        clearBusyUI('エラー：' + msg);
                    } finally {
                        try { currentStream?.getTracks()?.forEach(t => t.stop()); } catch (_) {}
                        currentStream = null;
                        mediaRecorder = null;
                        recordedChunks = [];
                        isRecording = false;
                    }
                };

                mediaRecorder.start();
                setRecordingUI(true);
                if (stopRequested) stopRecording();
            } catch (err) {
                console.error(err);
                isRecording = false;
                clearBusyUI('マイク権限が必要です。ブラウザの許可を確認してください。');
            }
        }

        function stopRecording() {
            if (!isRecording) return;
            if (!mediaRecorder) { stopRequested = true; return; }
            try {
                if (mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            } catch (err) {
                console.error(err);
                isRecording = false;
                clearBusyUI('エラー：録音停止に失敗しました');
            }
        }

        async function sendAudioForCoaching(audioBlob) {
            const targetPhrase = (targetPhraseEl?.innerText || '').trim();
            transcriptText.innerHTML = '（文字起こし中…）';

            const fd = new FormData();
            const ext = (audioBlob.type || '').includes('ogg') ? 'ogg' : 'webm';
            fd.append('audio', audioBlob, `recording.${ext}`);
            fd.append('targetPhrase', targetPhrase);

            const res = await fetch('/api/coach', { method: 'POST', body: fd });
            const rawText = await res.text().catch(() => '');
            if (!res.ok) {
                let msg = rawText;
                try {
                    const errBody = JSON.parse(rawText);
                    if (errBody.error) msg = errBody.error;
                    if (errBody.detail) msg += ' 【詳細】' + errBody.detail;
                    if (errBody.hint) msg += ' ' + errBody.hint;
                } catch (_) {}
                throw new Error(`[${res.status}] ${msg || res.statusText}`);
            }

            const data = JSON.parse(rawText);
            renderTranscript(data.transcript);

            const a = data?.analysis || {};
            updateScores(clampScore(a.rhythm_score), clampScore(a.vowel_score), clampScore(a.britishness_score));

            renderStructuredFeedback(data);
            renderCoachVisual(a.ipa_target);
        }

        function bindTapToToggle(el) {
            el.addEventListener('click', (e) => {
                e.preventDefault();
                if (!isRecording) startRecording();
                else stopRecording();
            });
        }

        function bindHoldToRecord(el) {
            el.addEventListener('pointerdown', (e) => {
                e.preventDefault();
                el.setPointerCapture?.(e.pointerId);
                startRecording();
            });
            el.addEventListener('pointerup', (e) => { e.preventDefault(); stopRecording(); });
            el.addEventListener('pointercancel', stopRecording);
            el.addEventListener('pointerleave', (e) => { if (e.buttons) stopRecording(); });
            el.addEventListener('contextmenu', (e) => e.preventDefault());
        }

        nextStepBtn.addEventListener('click', nextPhrase);
        setPhraseIndex(0);

        if (!navigator.mediaDevices?.getUserMedia) {
            statusText.textContent = 'このブラウザは録音に対応していません（Chrome推奨）';
            recordBtn.disabled = true;
            recordBtn.classList.add('opacity-60');
        } else {
            if (isTouchDevice()) {
                statusText.textContent = 'タップで録音開始／もう一度タップで停止';
                bindTapToToggle(recordBtn);
            } else {
                bindHoldToRecord(recordBtn);
            }
        }
    </script>
</body>
</html>
