<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>British English Coach — 専属RP発音コーチ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,600;1,600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --oxford-blue: #002147;
            --racing-green: #004225;
            --british-red: #B22234;
        }
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; }
        .font-serif-title { font-family: 'Cormorant Garamond', serif; }
        
        /* 録音中のアニメーション */
        .recording-glow { animation: pulse 1.5s infinite; background-color: var(--british-red) !important; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(178, 34, 52, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(178, 34, 52, 0); }
            100% { box-shadow: 0 0 0 0 rgba(178, 34, 52, 0); }
        }

        .gauge-bar { transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .coach-card { border-left: 4px solid var(--oxford-blue); }
        .btn-primary { background-color: var(--oxford-blue); transition: all 0.2s; }
        .btn-primary:hover { background-color: #003366; transform: translateY(-1px); }
    </style>
</head>
<body class="min-h-screen text-slate-800 antialiased">
    <div class="max-w-lg mx-auto bg-white min-h-screen shadow-2xl border-x border-slate-200">
        <header class="bg-[#002147] text-white px-8 py-7 shadow-md">
            <h1 class="font-serif-title text-3xl font-bold tracking-tight">British English Coach</h1>
            <p class="text-xs text-blue-200 mt-1 uppercase tracking-[0.2em] font-medium">Professional RP Coaching</p>
        </header>

        <main class="p-6 pb-12">
            <section class="mb-8">
                <div class="flex justify-between items-end mb-2">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Target Phrase</p>
                    <p class="text-[10px] font-medium text-slate-400">Step <span id="phraseStep" class="text-oxford-blue font-bold">1</span> of <span id="phraseTotal">5</span></p>
                </div>
                <div class="relative">
                    <p id="targetPhrase" class="text-xl font-semibold text-slate-800 leading-relaxed bg-slate-50 border border-slate-200 rounded-2xl p-5 shadow-sm">
                        </p>
                </div>
            </section>

            <section class="mb-8 bg-blue-50/50 border border-blue-100 rounded-2xl p-5">
                <div class="flex items-center gap-2 mb-3">
                    <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                    <p class="text-[10px] font-bold text-blue-900 uppercase tracking-widest">Visual Feedback</p>
                </div>
                <div id="coachVisual" class="space-y-3">
                    <div class="flex items-baseline gap-3">
                        <p id="drillIpa" class="text-2xl font-bold text-[#002147] font-mono tracking-tight">/ — /</p>
                        <p id="drillTitle" class="text-xs font-bold text-blue-700 bg-blue-100 px-2 py-0.5 rounded italic">Target Sound</p>
                    </div>
                    <p id="drillTip" class="text-sm text-slate-600 leading-relaxed">
                        録音を開始してください。イギリス英語特有の母音やリズムを分析します。
                    </p>
                </div>
            </section>

            <section class="flex flex-col items-center gap-5 mb-10">
                <div class="relative">
                    <button id="recordBtn" type="button" class="w-24 h-24 rounded-full btn-primary text-white flex items-center justify-center shadow-xl active:scale-90 focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                        </svg>
                    </button>
                </div>
                <p id="statusText" class="text-sm font-medium text-slate-500 tracking-wide text-center">
                    押している間だけ録音 / 離すと分析開始
                </p>
            </section>

            <section class="grid grid-cols-3 gap-4 mb-8">
                <div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-2 tracking-tighter">Rhythm</p>
                    <div class="h-1.5 bg-slate-100 rounded-full overflow-hidden mb-2">
                        <div id="rhythmBar" class="gauge-bar h-full bg-[#002147]" style="width: 0%"></div>
                    </div>
                    <p id="rhythmScore" class="text-lg font-bold text-slate-800">—</p>
                </div>
                <div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-2 tracking-tighter">Vowel</p>
                    <div class="h-1.5 bg-slate-100 rounded-full overflow-hidden mb-2">
                        <div id="vowelBar" class="gauge-bar h-full bg-[#002147]" style="width: 0%"></div>
                    </div>
                    <p id="vowelScore" class="text-lg font-bold text-slate-800">—</p>
                </div>
                <div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-2 tracking-tighter">Britishness</p>
                    <div class="h-1.5 bg-slate-100 rounded-full overflow-hidden mb-2">
                        <div id="britishBar" class="gauge-bar h-full bg-[#004225]" style="width: 0%"></div>
                    </div>
                    <p id="britishScore" class="text-lg font-bold text-emerald-700">—</p>
                </div>
            </section>

            <section class="mb-8">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Your Transcript</p>
                <div id="transcriptText" class="text-sm text-slate-600 bg-slate-50/50 border border-slate-200 rounded-xl p-4 min-h-[3rem] italic">
                    ...
                </div>
            </section>

            <section class="mb-10">
                <p class="text-[10px] font-bold text-[#002147] uppercase tracking-widest mb-3">Coach's Professional Feedback</p>
                <div id="feedbackText" class="coach-card bg-slate-50 rounded-r-2xl p-5 shadow-inner">
                    <p class="text-slate-400 text-sm italic">録音を待機中...</p>
                </div>
            </section>

            <section id="nextStepArea" class="hidden animate-in fade-in slide-in-from-bottom-4 duration-500">
                <div class="bg-emerald-50 border border-emerald-100 rounded-xl p-4 mb-4">
                    <p class="text-[10px] font-bold text-emerald-800 uppercase mb-1">Coach's Suggestion</p>
                    <p id="nextStepHint" class="text-xs text-emerald-700 font-medium"></p>
                </div>
                <button id="nextStepBtn" type="button" class="w-full py-4 px-6 rounded-2xl bg-[#002147] text-white font-bold text-sm shadow-lg hover:shadow-xl active:scale-95 transition-all">
                    Next Challenge: 次の課題へ
                </button>
            </section>
        </main>
    </div>

    <script>
        // --- 1. 定数と例文データ (British English) ---
        const BRITISH_PHRASES = [
            { 
                text: "Actually, I'd rather have a cup of tea in the garden, if you don't mind.", 
                focus: "rather/tea", 
                hint: "母音 /ɑː/ を喉の奥で深く響かせましょう。" 
            },
            { 
                text: "The theatre in the city centre was cancelled due to the rain.", 
                focus: "theatre/centre", 
                hint: "-re の綴りと、rを巻かない発音を意識して。" 
            },
            { 
                text: "Mind the gap between the train and the platform at Victoria Station.", 
                focus: "gap/platform", 
                hint: "ロンドン地下鉄の象徴的なフレーズです。Tを明瞭に。" 
            },
            { 
                text: "I fancy a bit of a natter over some biscuits and a cuppa.", 
                focus: "fancy/biscuits", 
                hint: "イギリス特有の表現です。リズムを弾ませて。" 
            },
            { 
                text: "It's quite a long way to the flat, but the lift is working.", 
                focus: "quite/flat", 
                hint: "quite /aɪ/ と flat /æ/ の違いをはっきりと。" 
            }
        ];

        let phraseIndex = 0;
        let isRecording = false;
        let mediaRecorder = null;
        let recordedChunks = [];

        // UI要素
        const recordBtn = document.getElementById('recordBtn');
        const statusText = document.getElementById('statusText');
        const transcriptText = document.getElementById('transcriptText');
        const feedbackText = document.getElementById('feedbackText');
        const targetPhraseEl = document.getElementById('targetPhrase');
        const nextStepArea = document.getElementById('nextStepArea');
        const nextStepBtn = document.getElementById('nextStepBtn');

        // --- 2. 初期化 ---
        function init() {
            setPhrase(0);
            if (isTouchDevice()) {
                statusText.textContent = "タップで録音 / もう一度押して分析";
                recordBtn.onclick = toggleRecording;
            } else {
                recordBtn.onpointerdown = startRecording;
                recordBtn.onpointerup = stopRecording;
                recordBtn.onpointerleave = (e) => { if(isRecording) stopRecording(); };
            }
        }

        function setPhrase(index) {
            phraseIndex = index % BRITISH_PHRASES.length;
            const item = BRITISH_PHRASES[phraseIndex];
            
            document.getElementById('phraseStep').textContent = phraseIndex + 1;
            document.getElementById('phraseTotal').textContent = BRITISH_PHRASES.length;
            
            // 重要ワードのハイライト
            let html = item.text;
            const keywords = ["tea", "theatre", "centre", "garden", "rather", "gap", "fancy", "flat", "lift"];
            keywords.forEach(word => {
                const regex = new RegExp(`\\b${word}\\b`, 'gi');
                html = html.replace(regex, `<span class="bg-amber-100 text-amber-900 px-1 border-b-2 border-amber-400">$&</span>`);
            });
            targetPhraseEl.innerHTML = html;
            
            // 状態リセット
            nextStepArea.classList.add('hidden');
            document.getElementById('drillIpa').textContent = "/ — /";
            document.getElementById('drillTip').textContent = item.hint;
        }

        // --- 3. 録音ロジック ---
        async function startRecording() {
            if (isRecording) return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                recordedChunks = [];
                
                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
                mediaRecorder.onstop = processRecording;
                
                mediaRecorder.start();
                isRecording = true;
                recordBtn.classList.add('recording-glow');
                statusText.textContent = "録音中...（離すと停止）";
                statusText.classList.add('text-red-600');
            } catch (err) {
                alert("マイクの使用を許可してください。");
            }
        }

        function stopRecording() {
            if (!isRecording) return;
            mediaRecorder.stop();
            isRecording = false;
            recordBtn.classList.remove('recording-glow');
            statusText.textContent = "分析中...";
            statusText.classList.remove('text-red-600');
        }

        function toggleRecording() {
            isRecording ? stopRecording() : startRecording();
        }

        // --- 4. API通信とUI反映 ---
        async function processRecording() {
            const blob = new Blob(recordedChunks, { type: 'audio/webm' });
            const formData = new FormData();
            formData.append('audio', blob);
            formData.append('targetPhrase', targetPhraseEl.innerText);

            try {
                const response = await fetch('/api/coach', { method: 'POST', body: formData });
                const data = await response.json();
                updateUI(data);
            } catch (err) {
                feedbackText.innerHTML = `<p class="text-red-500 text-xs">エラーが発生しました: ${err.message}</p>`;
            }
        }

        function updateUI(data) {
            const analysis = data.analysis || {};
            
            // スコアとバー
            const updateScore = (id, barId, val) => {
                const score = Math.round(val || 0);
                document.getElementById(id).textContent = score + "%";
                document.getElementById(barId).style.width = score + "%";
            };
            updateScore('rhythmScore', 'rhythmBar', analysis.rhythm_score);
            updateScore('vowelScore', 'vowelBar', analysis.vowel_score);
            updateScore('britishScore', 'britishBar', analysis.britishness_score);

            // テキスト関連
            transcriptText.textContent = data.transcript || "聞き取れませんでした";
            
            document.getElementById('drillIpa').textContent = analysis.ipa_target || "/ — /";
            
            feedbackText.innerHTML = `<p class="text-sm text-slate-700 leading-relaxed whitespace-pre-wrap">${analysis.detailed_feedback || "フィードバックを取得できませんでした。"}</p>`;

            // 次のステップ
            if (data.next_step) {
                document.getElementById('nextStepHint').textContent = data.next_step.text || "素晴らしい！次の課題に進みましょう。";
                nextStepArea.classList.remove('hidden');
            }
        }

        // --- 5. ユーティリティ ---
        function isTouchDevice() {
            return (('ontouchstart' in window) || (navigator.maxTouchPoints > 0));
        }

        nextStepBtn.onclick = () => setPhrase(phraseIndex + 1);

        init();
    </script>
</body>
</html>